
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Comprehensive API Performance Report</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --panel: #ffffff;
      --card: #ffffff;
      --muted: #475569;
      --text: #0f172a;
      --accent: #2563eb;
      --success: #4088d9;
      --warn: #d97706;
      --error: #dc2626;
      --link: #2563eb;
      --chip: #eef2f7;
      --border: #e6e6e6;
      --shadow: none;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
    }
    .wrap { max-width:1180px; margin:24px auto 48px; padding:0 16px; }
    header {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: saturate(180%) blur(10px);
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }
    .bar { max-width:1180px; margin:0 auto; display:flex; gap:16px; align-items:center; padding:14px 24px; }
    .title { font-weight:700; letter-spacing:.2px; }
    .subtitle { color: var(--muted); font-size:13px; }
    .chip { background: var(--chip); border: 1px solid var(--border); color: var(--text); padding:6px 10px; border-radius:999px; font-size:12px; }
    .grid { display:grid; gap:16px; }
    .grid.kpi { grid-template-columns: repeat(4, minmax(0,1fr)); }
    .grid.two { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid.three { grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width:1100px) {
      .grid.kpi { grid-template-columns: repeat(2, minmax(0,1fr)); }
      .grid.two, .grid.three { grid-template-columns: repeat(1, minmax(0,1fr)); }
    }
    section {
      background: var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px 14px 10px;
    }
    .kpi {
      background: var(--card); border:1px solid var(--border); border-radius:12px;
      padding:14px 14px 10px; display:flex; align-items:baseline; justify-content:space-between; gap:8px;
    }
    .kpi .label { color: var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.08em; }
    .kpi .value { font-size:22px; font-weight:700; }
    .chip { display:inline-block; }
    .toolbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom: 20px; }
    .toolbar input {
      background: var(--card); border:1px solid var(--border); border-radius:10px;
      padding:10px 12px; color: var(--text); outline:none; min-width:260px;
    }
    h1,h2,h3{ margin:0; }
    h2{ font-size:18px; margin-bottom:12px; }
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius:12px;
      padding:14px 14px 10px;
      box-shadow: var(--shadow);
    }
    @media print {
    body { margin: 0; padding: 0; font-size: 10pt; }  /* Tighten overall */
    .grid, .grid.kpi, .grid.two, .grid.three { 
        display: block !important;  /* Stack grids vertically */
        grid-template-columns: none !important;
    }
    section, .card { 
        break-inside: avoid;  /* Prevent splits in cards/sections */
        margin: 5mm 0; padding: 5mm;  /* Reduce white space */
        box-shadow: none; border: none;  /* Remove visuals for print */
    }
    .chip, .subtitle { display: none; }  /* Hide non-essential like filters/tips */
    .bar, header { position: relative !important; }  /* Unstick headers */
    canvas { width: 100% !important; height: auto !important; }  /* Fit charts */
    @page { margin: 10mm; }  /* Global page margins */
    .apis-detail { page-break-before: always; }  /* Force new page for details if needed */
}
    .api-card { display: flex; flex-direction: column; gap:12px; }
    .api-head { display: flex; justify-content: space-between; align-items: center; gap:12px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1 class="title">Comprehensive API Performance Report</h1>
      <p class="subtitle">Aggregated k6 results by API and test profile</p>
    </div>
  </header>
  <div class="wrap">
    <section class="toolbar">
      <input type="text" id="filter" placeholder="Filter by API name or endpoint...">
      <p class="subtitle">Tip: Use the nginx server on port 8069 to browse generated results and this dashboard as before.</p>
    </section>
    <div class="grid two">
      <div class="card">
        <h2>Latency comparison</h2>
        <canvas id="latencyChart"></canvas>
        <div class="chip">
          Avg <span style="color:var(--accent)">●</span>
          P90 <span style="color:var(--success)">●</span>
          P95 <span style="color:var(--error)">●</span>
        </div>
      </div>
      <div class="card">
        <h2>Reliability and throughput</h2>
        <canvas id="reliabilityChart"></canvas>
        <div class="chip">
          Error rate <span style="color:var(--error)">●</span>
          RPS <span style="color:var(--success)">●</span>
        </div>
      </div>
    </div>
    <br>
    <section>
      <h2>APIs detail</h2>
      <div id="apiCards" class="grid three"></div>
    </section>
    <p class="subtitle">Generated from k6 CSV/metadata artifacts and rendered client-side for static hosting and PDF export. No backend changes required.</p>
  </div>

  <script>
    const reportList = [{"csv": "create_post_1-post-smoke-results.csv", "meta": "create_post_1-post-smoke-metadata.json"}, {"csv": "create_comment_1-post-smoke-results.csv", "meta": "create_comment_1-post-smoke-metadata.json"}];

    let latencyChart;
    let reliabilityChart;

    async function loadData() {
      const data = [];
      for (const r of reportList) {
        try {
          const metaResp = await fetch(r.meta);
          const meta = await metaResp.json();
          const csvResp = await fetch(r.csv);
          const csvText = await csvResp.text();
          const metrics = parseCsv(csvText);
          data.push({ meta, metrics });
        } catch (e) {
          console.error(`Failed to load ${r.csv} or ${r.meta}:`, e);
        }
      }
      return data;
    }

    function parseCsv(text) {
      const lines = text.split('\n').slice(1).filter(line => line.trim());
      const result = {};
      lines.forEach(line => {
        const [metric, type, valueStr] = line.split(',', 3);
        const cleanedValue = valueStr.trim().replace(/^"|"$/g, '');
        if (!result[metric]) result[metric] = { type };
        const [key, val] = cleanedValue.split('=');
        result[metric][key] = isNaN(parseFloat(val)) ? val : parseFloat(val);
      });
      return result;
    }

    function renderCharts(filteredData) {
      const labels = filteredData.map(d => `${d.meta.requestName} (${d.meta.testType})`);

      if (latencyChart) latencyChart.destroy();
      const latencyCtx = document.getElementById('latencyChart').getContext('2d');
      latencyChart = new Chart(latencyCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Avg', data: filteredData.map(d => d.metrics.http_req_duration.avg), backgroundColor: '#2563eb' },
            { label: 'P90', data: filteredData.map(d => d.metrics.http_req_duration['p(90)']), backgroundColor: '#4088d9' },
            { label: 'P95', data: filteredData.map(d => d.metrics.http_req_duration['p(95)']), backgroundColor: '#ef4444' }
          ]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, title: { display: true, text: 'ms' } } }
        }
      });

      if (reliabilityChart) reliabilityChart.destroy();
      const reliabilityCtx = document.getElementById('reliabilityChart').getContext('2d');
      reliabilityChart = new Chart(reliabilityCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Error Rate (%)', data: filteredData.map(d => (d.metrics.http_req_failed ? d.metrics.http_req_failed.rate * 100 : 0)), backgroundColor: '#ef4444' },
            { label: 'RPS', data: filteredData.map(d => d.metrics.http_reqs.rate), backgroundColor: '#2563eb' }
          ]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function renderCards(filteredData) {
      const container = document.getElementById('apiCards');
      container.innerHTML = '';
      filteredData.forEach(d => {
        const card = document.createElement('div');
        card.className = 'card api-card';
        card.innerHTML = `
          <div class="api-head">
            <h3>${d.meta.requestName} (${d.meta.testType})</h3>
            <span class="chip">${d.meta.requestMethod} ${d.meta.endpoint}</span>
          </div>
            <div class="kpi">
              <div class="label">Total Requests</div>
              <div class="value">${Math.round(d.metrics.http_reqs.count || 0)}</div>
            </div>
            <div class="kpi">
              <div class="label">Avg Response (ms)</div>
              <div class="value">${d.metrics.http_req_duration.avg.toFixed(2)}</div>
            </div>
            <div class="kpi">
              <div class="label">Failure Rate</div>
              <div class="value">${(d.metrics.http_req_failed ? (d.metrics.http_req_failed.rate * 100).toFixed(2) : 0)}%</div>
            </div>
            <div class="kpi">
              <div class="label">Max VUs</div>
              <div class="value">${d.metrics.vus_max.value || 'N/A'}</div>
            </div>
        `;
        container.appendChild(card);
      });
    }

    window.onload = async () => {
      const data = await loadData();
      if (data.length === 0) {
        console.error('No data loaded from reports');
        return;
      }
      renderCharts(data);
      renderCards(data);

      const filterInput = document.getElementById('filter');
      filterInput.addEventListener('input', () => {
        const term = filterInput.value.toLowerCase();
        const filtered = data.filter(d =>
          d.meta.requestName.toLowerCase().includes(term) ||
          d.meta.endpoint.toLowerCase().includes(term)
        );
        renderCharts(filtered);
        renderCards(filtered);
      });
    };
  </script>
</body>
</html>
    